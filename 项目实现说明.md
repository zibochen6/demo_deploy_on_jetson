# Jetson Demo Web 平台 — 项目实现说明

本文档详细总结整个项目的实现流程与关键细节，便于维护与扩展。

---

## 1. 项目概述与目标

### 1.1 目标

- **部署端**：在 **PC/服务器** 上运行 Web 服务，通过浏览器操作。
- **执行端**：支持 **本地模式**（本机即 Jetson）或 **远程模式**（通过 SSH 在 Jetson 上执行）。
- **功能**：连接 Jetson → 一键部署 YOLO 环境 → 运行 Demo，在浏览器中查看 **实时 MJPEG 视频流**（摄像头 + YOLO 检测）。

### 1.2 技术栈

| 层级     | 技术 |
|----------|------|
| 后端     | Python 3，FastAPI，uvicorn，paramiko（SSH/SFTP） |
| 前端     | 静态 HTML + 原生 JS，无构建 |
| 推流协议 | MJPEG over HTTP（multipart/x-mixed-replace） |
| 部署日志 | Server-Sent Events (SSE) |

---

## 2. 目录与文件结构

```
setup/
├── 项目实现说明.md          # 本文档
├── README.md
├── web/                     # Web 服务与前端
│   ├── main.py               # FastAPI 应用、API、双模式逻辑
│   ├── demos.py               # Demo 元数据与路径（本地/Jetson）
│   ├── stream_yolo.py        # 摄像头 + YOLO 推理，输出「4 字节长度 + JPEG」到 stdout
│   ├── requirements.txt      # fastapi, uvicorn, paramiko
│   ├── README.md
│   └── static/
│       ├── index.html        # 首页：连接 Jetson、Demo 列表
│       └── demo.html         # Demo 详情：一键部署、运行 Demo、MJPEG 显示
└── yolo11/                   # 本地或部署产物：venv、模型、脚本等
    ├── .venv/
    ├── yolo11n.pt
    ├── stream_yolo.py        # 可能由部署或上传产生
    └── run_yolo_*.py
```

- **PC 上**：只运行 `web/` 下的服务；`demos.py` 中的路径在**远程模式**下表示 **Jetson 上的绝对路径**（由连接时 `jetson_project_path` 决定）。
- **Jetson 上**：需有项目目录（默认如 `/home/seeed/setup`），内含部署脚本、可选 `web/stream_yolo.py`，以及部署后生成的 `yolo11/.venv`、`yolo11/yolo11n.pt` 等。

---

## 3. 架构与双模式

### 3.1 双模式判定

- **本地模式**：未连接 Jetson（`_current_target` 为 None，且请求未带有效 `X-Session-Token`）。部署与推流在本机执行，使用 `demos.py` 中的 `local_*` 路径（相对于 `PROJECT_ROOT`）。
- **远程模式**：已连接 Jetson（存在 `_current_target` 或 `_sessions[token]`）。部署与推流通过 **paramiko SSH** 在 Jetson 上执行，使用 `jetson_paths(jetson_project, demo_id)` 得到 Jetson 上的绝对路径。

### 3.2 会话与连接

- **连接**：`POST /api/connect` 使用 host、port、username、password、jetson_project_path 建立 SSH，将 `paramiko.SSHClient` 及上述信息存入 `_current_target`，并生成 `session_id` 写入 `_sessions[session_id]`。
- **前端**：将 `session_id` 存于 `localStorage`，请求时通过 Header `X-Session-Token` 携带；`_get_target(request)` 优先按 token 从 `_sessions` 取目标，否则用 `_current_target`。
- **写权限密码**：`POST /api/connect/stream-upload-password` 将密码写入当前 target（`target["stream_upload_password"]`），仅用于远程模式下 SFTP 失败时通过 sudo 写入/改属主 `stream_yolo.py`。

### 3.3 数据流概览

```
[浏览器] <--HTTP/SSE/MJPEG--> [PC 上 main.py] <--SSH/管道--> [Jetson 上脚本/进程]
```

- 部署：浏览器请求部署 → main.py 在本地或通过 SSH 执行部署脚本 → 日志经 SSE 推回浏览器。
- 推流：浏览器请求 MJPEG → main.py 在本地起子进程或在 Jetson 上 SSH 执行 `stream_yolo.py` → 帧数据经管道或 SSH channel 回 main.py → 封装为 MJPEG 流返回浏览器。

---

## 4. 核心流程

### 4.1 连接 Jetson（仅远程）

1. 用户在前端填写 IP、端口、用户名、密码、Jetson 项目路径（可选）。
2. `POST /api/connect`：paramiko 建立 SSH，保存到 `_current_target` 和 `_sessions`，返回 `session_id`。
3. 前端保存 `session_id`，后续请求带 `X-Session-Token`。

### 4.2 一键部署

1. 用户进入 Demo 详情页，可选填「密码」（仅本地模式，供脚本内 sudo 使用），点击「一键部署」。
2. **本地模式**：`main.py` 使用 `local_script_path`、`local_work_dir` 起子进程执行部署脚本（可选 `sudo -S`）；stdout 由线程写入 `log_queue`。
3. **远程模式**：`main.py` 使用 `jetson_paths` 得到 `script_path`、`work_dir`，通过 SSH `exec_command` 执行 `cd work_dir && bash script_path`；channel 的 stdout 由线程写入 `log_queue`。
4. `GET /api/demos/{id}/deploy/stream` 返回 SSE 流：循环从 `log_queue` 取行，推 `data: ...`；进程或 channel 结束时发送 `event: done`，并清理 `_deploy_state[demo_id]`。
5. 部署状态：本地用 `is_deployed_local(demo_id)`（检查 venv 与模型文件是否存在）；远程用 `_is_deployed_remote`（SSH 执行 `test -f venv && test -f model && echo ok`）。

### 4.3 运行 Demo（推流）

1. 用户点击「运行 Demo」；若已连接 Jetson，可先填「Jetson 写权限密码」并保存（用于 sudo 上传/改属主）。
2. **脚本来源（仅远程）**：
   - 优先用 **SFTP** 将 PC 上的 `stream_yolo.py` 上传到 Jetson 的 `yolo_dir/stream_yolo.py`。
   - 若 SFTP 因权限失败且已配置「写权限密码」：先执行 **sudo tee** 写入 `yolo_dir/stream_yolo.py`，再执行 **sudo chown 用户:用户** 该文件，保证以 SSH 用户执行时有权运行；**不再**先回退到 Jetson 上已有的 `web/stream_yolo.py`。
   - 若未配置密码或 sudo 失败：再回退到 Jetson 上已有的 `paths["stream_script"]`（即 `jetson_project/web/stream_yolo.py`）。
3. **执行**：
   - **本地**：`subprocess.Popen` 启动 `venv_python stream_script`，环境变量 `YOLO11_PROJECT_DIR`、`YOLO11_MODEL_PATH`、`PYTHONUNBUFFERED=1`，stdout/stderr 为 PIPE。
   - **远程**：SSH `exec_command` 执行 `cd yolo_dir && YOLO11_PROJECT_DIR=... YOLO11_MODEL_PATH=... PYTHONUNBUFFERED=1 venv_python stream_script`。
4. **帧协议**：`stream_yolo.py` 向 stdout 写「4 字节大端帧长 + JPEG 原始字节」，主进程用相同协议从子进程或 SSH channel 读帧。
5. **首帧与超时**：主进程等待首帧（本地 45s，远程 90s）；若超时或收到 `None`（读线程结束），则清理进程/channel，返回 503 或带 stderr 的 503。
6. **MJPEG 响应**：收到首帧后，以 `StreamingResponse` 返回 `multipart/x-mixed-replace; boundary=frame`，generator 先 yield 首帧，再循环从 `frame_queue` 取 JPEG 直到 `None`；结束时关闭 channel 或 terminate 子进程，并清理 `_stream_*` 状态。

---

## 5. 实现细节

### 5.1 stream_yolo.py（子进程/远程脚本）

- **职责**：读环境变量 `YOLO11_PROJECT_DIR`、`YOLO11_MODEL_PATH`、`YOLO11_CAMERA_ID`；加载 YOLO 模型；打开摄像头（aarch64 下可走 GStreamer）；循环读帧 → 推理 → 标注 → 编码 JPEG → 按「4 字节长度 + 内容」写 stdout。
- **stderr**：用 `_err()` 写行并 flush；开头设置 `sys.stderr.reconfigure(line_buffering=True)`（若支持）；多处阶段日志（如 "stream_yolo starting..."、"Loading YOLO model..."、"YOLO model loaded."、"Opening camera..."、"Camera opened."、"First frame encoding..."）便于 503 时定位阶段。
- **isatty**：若 `sys.stdout.isatty()` 为真则直接退出并提示不要终端直接运行（避免二进制刷屏）；通过 main.py 或 SSH 调用时通常非 TTY。

### 5.2 主进程读帧与 stderr（远程）

- **帧读取**：`_stream_yolo_reader_ssh` 在独立线程中循环读 channel 的 stdout，解析 4 字节长度 + JPEG，放入 `frame_queue`；结束时向队列放 `None`。
- **stderr 采集**：`_stream_yolo_stderr_reader_ssh` 在另一线程中循环读 `channel.recv_stderr()`，追加到 `stderr_parts`；进程退出后再读一段 stderr 后退出。主进程在 503 分支先对该线程 `join(timeout=1.0)`，再合并 `stderr_parts` 得到 `stderr_text`。
- **exit_status**：503 时轮询 `channel.exit_status_ready()`（最多约 1 秒），再 `recv_exit_status()`，避免 exit_status 一直为 None。

### 5.3 上传与权限（远程）

- **SFTP**：优先 `client.open_sftp()` 后 `put(local_stream_script, remote_stream_script)`。若失败且为权限错误且已配置 `stream_upload_password`，则：
  - **sudo tee**：`_upload_stream_script_via_sudo` 执行 `sudo -S tee 'path' > /dev/null`，stdin 先送密码再送文件内容。
  - **sudo chown**：`_chown_stream_script_via_sudo` 执行 `sudo -S chown 'user:user' 'path'`，将文件属主改为当前 SSH 用户，便于后续直接执行。
- **回退**：仅在没有密码或 sudo 失败时，再检查 Jetson 上是否存在 `web/stream_yolo.py`，存在则用该路径执行。

### 5.4 503 与错误展示

- 未产出首帧或超时：清理 channel/进程，收集 stderr 与 exit_status，拼成 `err_msg` 写入 `_last_stream_error[demo_id]`，返回 503。
- 前端：`img.onerror` 时请求 `GET /api/demos/{id}/stream-last-error`，将返回的 `stderr` 显示在红色错误框内（不再把可能含二进制的 err_msg 写入服务端日志，避免终端乱码）。

### 5.5 信号与退出

- `_shutdown_and_exit` 注册 SIGINT/SIGTERM：关闭当前 SSH 连接、清理所有部署 channel/进程、清理所有推流 channel/进程及 stderr 采集相关 dict，最后 `sys.exit(0)`，确保端口释放。

---

## 6. API 一览

| 方法/路径 | 说明 |
|-----------|------|
| `POST /api/connect` | 连接 Jetson（body: host, port, username, password, jetson_project_path） |
| `GET /api/connect/status` | 当前是否已连接及 host |
| `POST /api/connect/stream-upload-password` | 保存/清除 Jetson 写权限密码（body: password） |
| `GET /api/demos` | Demo 列表 |
| `GET /api/demos/{id}/status` | 是否已部署（本地或远程） |
| `POST /api/demos/{id}/deploy` | 启动一键部署（body 可选 password），返回 stream_url |
| `GET /api/demos/{id}/deploy/stream` | SSE 部署日志流 |
| `POST /api/demos/{id}/deploy/cancel` | 取消部署，清除状态 |
| `GET /api/demos/{id}/stream` | MJPEG 视频流（GET 带查询 t 防缓存） |
| `GET /api/demos/{id}/stream-last-error` | 最近一次推流错误（含 stderr 与退出码等） |
| `GET /api/demos/{id}/stream-debug` | 调试：最近错误、路径、command_preview（可 SSH 手动执行） |

需要会话时，前端请求携带 Header `X-Session-Token: <session_id>`。

---

## 7. 前端页面与交互

### 7.1 首页（index.html）

- **连接 Jetson**：表单（IP、端口、用户名、密码、Jetson 项目路径）→ 提交 `POST /api/connect`，保存返回的 `session_id` 到 localStorage，并显示连接状态。
- **Demo 列表**：请求 `GET /api/demos`，按 `id`、`name`、`description` 渲染卡片；每个 Demo 链接到 `demo.html?id=<id>`；已连接时卡片可点击，未连接时样式灰显（由 `GET /api/demos/{id}/status` 与连接状态综合决定）。

### 7.2 Demo 详情页（demo.html）

- **一键部署**：可选填本地 sudo 密码 → `POST /api/demos/{id}/deploy`，用返回的 stream_url 建 EventSource 收 SSE，日志追加到页面；收到 `done` 后标记部署完成并刷新状态；若 409 则先 `POST deploy/cancel` 再提示重试。
- **Jetson 写权限密码**：仅已连接时显示；填写后点「保存」→ `POST /api/connect/stream-upload-password`。
- **运行 Demo**：点「运行 Demo」后，将 `img` 的 `src` 设为 `GET /api/demos/{id}/stream?t=...`，开始拉 MJPEG；`onerror` 时请求 `stream-last-error` 并在红色框内显示；停止时清空 `src` 并恢复「运行 Demo」按钮。

---

## 8. 配置与常量（demos.py）

- **DEMOS**：当前仅 `yolo11`，含 `script_name`（部署脚本）、`stream_script_name`、`work_dir_name`。
- **DEFAULT_JETSON_PROJECT**：默认 Jetson 项目路径，如 `/home/seeed/setup`。
- **jetson_paths(jetson_project, demo_id)**：返回 Jetson 上 `script_path`、`work_dir`、`yolo_dir`、`venv_python`、`model_path`、`stream_script`（`jetson_project/web/stream_yolo.py`）；本地路径由 `local_*` 系列函数给出，基于 `PROJECT_ROOT`。

---

## 9. 依赖与运行

- **依赖**：`web/requirements.txt` 中为 `fastapi`、`uvicorn[standard]`、`paramiko`。
- **运行**：在 `web/` 下执行 `pip install -r requirements.txt` 后 `python main.py`（或 `uvicorn main:app --host 0.0.0.0 --port 8000`）。
- **端口**：默认 8000；退出时通过信号处理关闭 SSH 与子进程并释放端口；若仍占用，可用 `lsof -i :8000` 等排查。

---

## 10. 错误处理与调试

- **部署 409**：已有部署进行中，可调用 `POST deploy/cancel` 后重试。
- **推流 409**：该 Demo 已在推流，需先停止再起新流。
- **推流 503**：未产出首帧或超时；页面显示「进程 stderr」与退出码；服务端只打摘要日志（demo_id、exit_status、stderr_len），不打 stderr 内容，避免终端乱码。
- **stream-debug**：在 SSH 到 Jetson 后，可按返回的 `command_preview` 手动执行，复现环境与错误。

以上即为本项目从连接、部署、推流到错误处理与调试的完整实现流程与细节说明。
